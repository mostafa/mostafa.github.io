<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Migration of Old Projects to Python 3</title>
    <meta name="description"
        content="A while ago I’ve self-assigned the daunting task of migrating an ancient API project written in Python 2.7 and Django to the latest stable Python 3.7 and Dja...">

    
    
    <link rel="stylesheet" href="https://mostafa.dev/assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <link rel="canonical" href="https://mostafa.dev/blog/migration-of-old-projects-to-python-3">
    <link rel="alternate" type="application/rss+xml" title="Welcome To My Blog"
        href="https://mostafa.dev/feed.xml">

    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Migration of Old Projects to Python 3 | Welcome To My Blog</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Migration of Old Projects to Python 3" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How to deal with 2to3, tests, incompatibilities and dependencies" />
<meta property="og:description" content="How to deal with 2to3, tests, incompatibilities and dependencies" />
<link rel="canonical" href="https://mostafa.dev/blog/migration-of-old-projects-to-python-3" />
<meta property="og:url" content="https://mostafa.dev/blog/migration-of-old-projects-to-python-3" />
<meta property="og:site_name" content="Welcome To My Blog" />
<meta property="og:image" content="https://mostafa.dev/img/1*S_BW9ZtWNkv502m_E5Ij2Q.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-08-03T00:00:00+02:00" />
<script type="application/ld+json">
{"image":"https://mostafa.dev/img/1*S_BW9ZtWNkv502m_E5Ij2Q.png","@type":"BlogPosting","url":"https://mostafa.dev/blog/migration-of-old-projects-to-python-3","headline":"Migration of Old Projects to Python 3","dateModified":"2019-08-03T00:00:00+02:00","datePublished":"2019-08-03T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mostafa.dev/blog/migration-of-old-projects-to-python-3"},"description":"How to deal with 2to3, tests, incompatibilities and dependencies","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <style>
        body {
            font-family: 'Ubuntu', sans-serif;
            font-size: 16px;
            line-height: 2;
            color: #181818;
            background-color: #fff;
        }

        .subtitle {
            color: rgba(0, 0, 0, 0.54) !important;
        }
    </style>
</head>

  <body>

    <header class="border-bottom-thick px-2 clearfix">
  <div class="left sm-width-full py-1 mt-1 mt-lg-0">
    <a class="align-middle link-primary text-accent" href="/">
      Welcome To My Blog
    </a>
  </div>
  <div class="right sm-width-full">
    <ul class="list-reset mt-lg-1 mb-2 mb-lg-1">
      
        
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/about/">
            About
          </a>
        </li>
        
      
        
      
        
      
        
      
    </ul>
  </div>
</header>


    <div>
      <article class="container px-2 mx-auto mb4" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="h1 col-9 sm-width-full mt-3 mb-0 pb-0 inline-block" itemprop="name headline">Migration of Old Projects to Python 3</h1>
    
        <h3 class="h3 col-9 sm-width-full mb-0 mt-0 inline-block subtitle" itemprop="name headline">How to deal with 2to3, tests, incompatibilities and dependencies
        </h3>
    
    
        <img class="col-12" src=/img/1*S_BW9ZtWNkv502m_E5Ij2Q.png/>
    
    <div class="col-3 sm-width-full mt-1 border-top-thin ">
        <p class="mb-3 py-2 h4">
            <time datetime="2019-08-03T00:00:00+02:00" itemprop="datePublished">Aug 3, 2019</time>
        </p>
    </div>

    <div class="prose" itemprop="articleBody">
        <p>A while ago I’ve self-assigned the daunting task of migrating an ancient API project written in Python 2.7 and Django to the latest stable Python 3.7 and Django 2.2. What at first seemed to be a piece of cake, turned out to be a Hydra, the multi-headed dragon, with its dependencies acting like an octopus.</p>

<p>I should admit that it was no easy task. I remember days I was banging my head to get that tiny fix to work as expected. But it all went well, hopefully, and I was able to migrate the project into an almost stable piece of code that just works.</p>

<p>As far as I know, the <a href="https://pythonclock.org/">countdown</a> of sunsetting of Python 2.7 is nearer than it appears. It sadly means that the version 2 flavor of Python won’t be maintained beyond 1st January 2020, which is inevitable. This date would be the official end of life of Python 2. This calls to an action to try to avoid it in the very near future for all companies using it.</p>

<p>The maintainers and the community worked hard to make everything compatible with the new Python 3 counterpart. The <a href="http://py3readiness.org/">readiness score</a> of Python 3 packages compatibility is eye-catching and a growing number of packages already has support for both version, while some completely switched to Python 3, specially those libraries written for newly widespread platforms, like shiny new database drivers. There is a <a href="https://python3statement.org/">timeline</a> for many important packages that will Python 3, and would drop support for the old Python 2.</p>

<p>Writing code against both flavors of Python and maintaining that code-base is really hard, since the <a href="https://galorath.com/software-maintenance-costs/">maintenance cost</a> is high. It is even more costly when you want to develop a library, since actual projects can stick with a specific flavor. There is always a trade-off between choosing the old version and having the latest greatest features. This being said, so much can be ported to the old version, and eventually portability becomes an issue itself. For almost every single package you find in Python 3, either in the standard library or in third-parties, there is a backport to Python 2, but <a href="https://www.reddit.com/r/Python/comments/41wl2t/libraries_that_support_python_3x_but_not_27/">this doesn’t hold true for the new features of Python 3</a>. Two simple example would be the very great <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a> and <a href="https://aiohttp.readthedocs.io/en/stable/">aiohttp</a> libraries.</p>

<p>As I said above, migration is no easy task, meaning that you cannot just change your interpreter version in your configuration file and headers and expect it to work right away. You should plan, analyze and iterate through the code-base to have everything migrated. I’ll explain each in greater details.</p>

<p>In the middle of doing this, I felt the need to have some search mechanism that can understand the structure of the Python code, so that I’ll be able to search inside imports in each file in the project, in order to able to understand where each module is actually used. So I’ve written a script that maps all python files inside the project to a nested dictionary, with its values being imports in that specific file. It then gives me the ability to search with a XPath-like syntax (via <a href="https://pypi.org/project/dpath/">dpath</a>). I’ll make it available soon as FOSS. It’s called “<em>Algae</em>”.</p>

<h3 id="methodology">Methodology</h3>

<p><img src="/img/1*p6cylSLFAjRPht0oIuvWJA.png" alt="" />Planning involves knowing the extent you wish your project to be updated. Sometimes you want to stick with an LTS version of some library and other times you want the latest cutting-edge features. This trade-off of stability versus trendiness is what to look for while planning for the migration.</p>

<p>This planning should also take into account the business side, although the focus of this article is on the engineering complications. Some changes should be organized and changed with the help of different departments. Otherwise it just won’t work. You’re going to deliver the same value or more to the customer, while decreasing technical debt and maintenance costs.</p>

<p>Analysis is the next step. You probably are already familiar with the project you are working on, or at least have worked on some parts of it and you know what it does. Analysis is to know what to keep, update or get rid of. Sometimes the project has grown organically and you no longer use some parts of it, like old API versions. Now is a good time to rethink. Sometimes a rewrite would be a more viable option, since the code-base is so messy that you no longer want to touch it. Other times, polishing and migration of the same code-base is easier and less costly. Whichever path you take would reveal your next moves.</p>

<p>Some changes include update to the backend services, like an update to a database driver that no longer supports outdated versions of that database. Some would break the tests, undoubtedly. This is what to expect while analyzing your code-base. You can’t just update the code and expect it to work without touching anything else. You have to think about it thoroughly.</p>

<p>Iteration is the actual work you want to do to ensure that you have an up-to-date application. It is called iteration, since you cannot move everything all at once. It is truly infeasible. Just don’t!</p>

<p>On each iteration, you actually take action by changing each part meticulously. Some parts are easy to change and require minimal amount of work, like updating small functional dependencies. Yet there are parts that require a lot of effort and time to change and test.</p>

<h3 id="recommendations">Recommendations</h3>

<h4 id="1-use-branching-to-isolate-changes">1. Use branching to isolate changes</h4>

<p>Each change should go into a new branch, e.g. git branch. This is to decrease clutter and friction with other parts. This would help narrow down the scope of change and would help you easily revert breaking or malfunctioning changes.</p>

<p>It is okay to build on top of the same change by sub-branching from the same branch you used to work on, and which is tested and worked as expected. You cannot push people to review your code changes, although being subjective, except the company’s future depends on it.</p>

<h4 id="2-upgrade-everything-to-latest-version-supported-by-python-27">2. Upgrade everything to latest version supported by Python 2.7</h4>

<p>The first iteration, besides version control and branching, would be to update dependencies to the latest version supported by Python 2.7. This helps find some bugs and alleviate many headaches afterwards. For example, the latest long-term support (LTS) version of Django supporting Python 2.7 is <a href="https://upgradedjango.com/1.11/">1.11.x</a> and of Django REST Framework is <a href="https://www.django-rest-framework.org/community/release-notes/#39x-series">3.9.x</a>. This means that the official support for these libraries on Python 2.7 is dropped and no longer available. It’s safe to say that upgrading to these versions has the least friction, unless your existing Django and DRF is ancient and unsupported.</p>

<p>Sometimes the changes in each version of Django and/or DRF is not backward compatible, so you have to keep an eye on Release Notes and Changelogs to adapt your code to the new changes.</p>

<h4 id="3-monitor-tests-continuous-integration-and-coverage">3. Monitor tests, Continuous Integration and coverage</h4>

<p>In this step, you should ensure that your tests pass and your coverage is not decreased dramatically. One of the biggest technical debts are not having enough tests, which would come to surface with users complaining about failures and developers seeing flaky test runs while updating code.</p>

<p>If that’s the case, consider writing more tests and invest more on CI workflows and pipelines. Of investment, I don’t necessarily mean money. Sometimes correcting a broken pipeline would help alleviate many issues in the future.</p>

<p>The next step is to monitor your test results to see if there are errors and warnings related to your code. Yes, I’ve seen tests pass, having many errors and warnings that are simply ignored. Test runner should be chosen wisely. Although the “unittest” standard library module is feature-rich, I do prefer “pytest” as a more flexible and extendable counterpart. This obviously doesn’t stop you from choosing your preferred test suite or even writing your own.</p>

<p>Your tests should not only include unittests. Integration, E2E, acceptance and performance test are just some of all the available test methodologies.</p>

<h4 id="4-run-2to3-on-your-code-base">4. Run 2to3 on your code-base</h4>

<p>After upgrading to the latest versions supported on Python 2.7 and testing to see if everything’s in order, now is the time to run the 2to3 tool on your code-base. This is a tool provided as part of the Python standard library to read the Python 2.x source code and transform them into a valid Python 3.x source code, through the so-called <a href="https://docs.python.org/3.7/library/2to3.html#fixers"><em>fixers</em></a>. Fixers are changes to the syntax and semantics of the source code from Python 2.x to 3.x. For example, in Python 2.x, it is not necessary to have parenthesis around the print function, but such functions no longer exist in Python 3.x. So the *print *fixer converts print function to print() all over your source code. Test again and again and make sure not to mess things up by not using branching.</p>

<p><em>Update:</em> a <a href="https://www.reddit.com/r/Python/comments/clugax/migration_of_old_projects_to_python_3_how_to_deal/evyutsc?utm_source=share&amp;utm_medium=web2x">user on reddit commented</a> that we could use <a href="https://pypi.org/project/modernize/">modernize</a> instead, to be able to spot more conversion errors, specially Unicode-related ones.</p>

<h4 id="5-change-your-interpreter-and-package-manager">5. Change your interpreter and package manager</h4>

<p>Now is the time to change your Python version to 3.7. Usually this is done by either installing it using a package manager, like APT, or just changing your Dockerfile FROM statement to include python:3.7.</p>

<p>This is the trickiest part, since many tests may fail, due to incompatible requirements and dependencies.</p>

<p>I do also recommend you to upgrade your package manager, pip, to the latest version.</p>

<h4 id="6-upgrade-your-dependencies">6. Upgrade your dependencies</h4>

<p>It is a good idea to check your dependencies before upgrade by running <a href="https://pypi.org/project/pipdeptree/">pipdeptree</a> on the requirements.txt file to detect circular and conflicting dependencies. The next best tool is the <a href="https://pypi.org/project/pur/">pip-update-requirements</a> that helps you upgrade all dependencies in the requirements.txt file.</p>

<p>Some dependencies are not easily upgradable, either because they are no longer supported anymore, specially on Python 3.x, or newer libraries have replaced them. For example, <a href="https://pypi.org/project/pycassa/">pycassa</a> is an old database driver for Cassandra supporting only Python 2.x, with <a href="https://github.com/pycassa/pycassa">its last commit on 17 January 2017</a>, which only supports Thrift protocol and there is no CQL support. But the official <a href="https://pypi.org/project/cassandra-driver/">DataStax Python Driver</a> replaced it deliberately supporting 2.7 and 3.x, which is easier to use and has more features and also is based on CQL.</p>

<p>Some other libraries have different issues. For example, python-social-auth package is deprecated and you should upgrade all your dependencies to social-auth-core and social-auth-app-django, in which you have to change many parts of the settings.py and your imports.</p>

<p>Some other libraries are replaced with better counterparts. For example, the python-memcached library has many other more up-to-date alternatives like pymemcache or pylibmc.</p>

<h4 id="7-upgrade-django-and-drf-to-latest-version">7. Upgrade Django and DRF to latest version</h4>

<p>The Django <a href="https://docs.djangoproject.com/en/dev/internals/release-process/">release process</a> is a good resource for knowing what to use and when to deprecate and get rid of old versions. The release roadmap on <a href="https://www.djangoproject.com/download/">Django download page</a> will give you a very quick view into the lifetime of each version.</p>

<p><img src="/img/1*aI2NZdsLaxzzu_fT8-0FNA.png" alt="" />Credits: <a href="https://www.djangoproject.com/download/">https://www.djangoproject.com/download/</a>As of now, the latest LTS version of Django that only supports Python 3.x is 2.2.x and the latest version of DRF is 3.10.x.</p>

<p>If you could eventually pass step 6, you can almost easily upgrade these versions and test if everything holds together.</p>

<p>Upgrading Django from 1.11.x to 2.x is a lot more painful than I thought it would be and it needs more time to be invested to get everything work correctly. There are removals, deprecations and changes that you should be aware of, to not break your system. Consider doing the upgrade step by step, otherwise you’ll be in big trouble hunting multiple unrelated bugs and the whole process would quickly become exhausting.</p>

<p>I hope you got an overview of what to expect while upgrading your Django and DRF application to the latest versions supported by Python 3.7. If you have any questions, comments or improvements, I’ll be really glad to hear them.</p>

    </div>

</article>

<div class="container mx-auto px-2 py-2 clearfix">
    <!-- Use if you want to show previous and next for all posts. -->



  <div class="col-4 sm-width-full left mr-lg-4 mt-3">
    <a class="no-underline border-top-thin py-1 block" href="https://mostafa.dev/blog/employment-contract">
      <span class="h5 bold text-accent">Previous</span>
      <p class="bold h3 link-primary mb-1">Employment Contract</p>
      <p>Disclaimer: I am not an attorney, a lawyer or an advocate whatsoever, so seek the help of a professional on...</p>
    </a>
  </div>
  
  
  <div class="col-4 sm-width-full left mt-3">
    <a class="no-underline border-top-thin py-1 block" href="https://mostafa.dev/blog/integrating-k6-with-apache-kafka">
      <span class="h5 bold text-accent">Next</span>
      <p class="bold h3 link-primary mb-1">Integrating k6 with Apache Kafka</p>
      <p>Undoubtedly, [Apache Kafka](https://kafka.apache.org/) is one of the most prominent pieces of software existing in today’s distributed architectures, from cloud-providers supporting...</p>
    </a>
  </div>


</div>
    </div>

    <div class="border-top-thin clearfix mt-2 mt-lg-4">
  <div class="container mx-auto px-2">
    <p class="col-8 sm-width-full left py-2 mb-0">This project is maintained by <a class="text-accent" href="https://github.com/mostafa">mostafa</a></p>
    <ul class="list-reset right clearfix sm-width-full py-2 mb-2 mb-lg-0">
      <li class="inline-block mr-1">
        <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="Welcome To My Blog">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </li>
      <li class="inline-block">
        <a class="github-button" href="https://github.com/mostafa/" data-icon="octicon-star" data-count-href="mostafa//stargazers" data-count-api="/repos/mostafa/#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star mostafa/ on GitHub">Star</a>
      </li>
    </ul>
  </div>
</div>


  </body>

</html>
